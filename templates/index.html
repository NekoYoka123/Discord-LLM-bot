<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord æœºå™¨äººæ§åˆ¶å° V2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 20px; padding-bottom: 50px;}
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: none; }
        .card-header { font-weight: bold; }
        textarea { font-family: monospace; font-size: 0.9rem; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4 text-center">ğŸ¤– è¶…çº§æœºå™¨äººåå°</h1>

    <div class="row">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">ğŸ§  AI å¤§è„‘è®¾å®š</div>
                <div class="card-body">
                    <form action="/save_ai_settings" method="POST">
                        <div class="mb-3">
                            <label class="form-label">ğŸ¤– ç³»ç»Ÿæç¤ºè¯ (System Prompt)</label>
                            <textarea class="form-control" name="system_prompt" rows="12" placeholder="ä½ å¯ä»¥åœ¨è¿™é‡Œè¾“å…¥å¾ˆé•¿çš„äººè®¾..." required>{{ config.system_prompt }}</textarea>
                            <div class="form-text">è¿™é‡Œå®šä¹‰æœºå™¨äººçš„åŸºæœ¬æ€§æ ¼ã€è¯´è¯æ–¹å¼å’Œè§„åˆ™ã€‚</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ğŸŒ¡ï¸ æ¸©åº¦ (Temperature): <span id="tempVal">{{ config.temperature }}</span></label>
                            <input type="range" class="form-range" name="temperature" min="0" max="2" step="0.1" value="{{ config.temperature }}" oninput="document.getElementById('tempVal').innerText = this.value">
                            <div class="form-text">0.0 = ç†æ€§ä¸¥è°¨, 1.0 = åˆ›æ„å‘æ•£, 2.0 = èƒ¡è¨€ä¹±è¯­</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ğŸ“š å½“å‰å…¨å±€çŸ¥è¯†åº“ (é€šè¿‡ /çŸ¥è¯†è¾“å…¥ æ·»åŠ )</label>
                            <div class="p-2 bg-light border rounded" style="max-height: 150px; overflow-y: auto;">
                                {% if config.global_knowledge %}
                                    <ul class="mb-0 ps-3">
                                    {% for k in config.global_knowledge %}
                                        <li>{{ k }}</li>
                                    {% endfor %}
                                    </ul>
                                {% else %}
                                    <span class="text-muted">æš‚æ— çŸ¥è¯†ï¼Œå» Discord ç”¨ /çŸ¥è¯†è¾“å…¥ æ·»åŠ </span>
                                {% endif %}
                            </div>
                        </div>

                        <button type="submit" class="btn btn-warning w-100">ä¿å­˜ AI è®¾å®š</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">æœºå™¨äººå®ä¾‹</div>
                <div class="card-body">
                    <table class="table table-sm align-middle">
                        <thead><tr><th>Bot</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                        <tbody>
                            {% for bot in bots %}
                            <tr>
                                <td>{{ bot.user }}<br><small class="text-muted">{{ bot.token_mask }}</small></td>
                                <td>{{ bot.status }}</td>
                                <td>
                                    <form action="/manage_bot" method="POST" class="d-inline">
                                        <input type="hidden" name="token" value="{{ bot.full_token }}">
                                        <button name="action" value="stop" class="btn btn-sm btn-outline-danger">åœ</button>
                                        <button name="action" value="start" class="btn btn-sm btn-outline-success">å¯</button>
                                        <button name="action" value="delete" class="btn btn-sm btn-link text-danger">åˆ </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <form action="/manage_bot" method="POST" class="input-group">
                        <input type="text" class="form-control" name="new_token" placeholder="Bot Token" required>
                        <button class="btn btn-primary" name="action" value="add">æ·»åŠ </button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-success text-white">API è¿æ¥</div>
                <div class="card-body">
                    <div class="mb-3">
                        <button id="testBtn" class="btn btn-sm btn-outline-success w-100">ğŸ›  æµ‹è¯•è¿æ¥</button>
                        <small id="testResult" class="d-block mt-1 text-center"></small>
                    </div>
                    <hr>
                    <form action="/update_api" method="POST">
                        <input type="text" class="form-control mb-2" name="url" placeholder="URL (e.g. https://open.ai/v1)" required>
                        <input type="text" class="form-control mb-2" name="model" value="gpt-3.5-turbo" placeholder="Model Name">
                        <textarea class="form-control mb-2" name="keys" rows="2" placeholder="Keys (æ¯è¡Œä¸€ä¸ª)" required></textarea>
                        <button type="submit" class="btn btn-success btn-sm w-100">æ·»åŠ  API ç»„</button>
                    </form>
                </div>
            </div>

             <div class="card">
                <div class="card-header bg-dark text-white">åå°å–Šè¯</div>
                <div class="card-body">
                    <form action="/admin_say" method="POST">
                        <select class="form-select mb-2" name="bot_token_mask">
                            {% for bot in bots %}
                            <option value="{{ bot.token_mask }}">{{ bot.user }}</option>
                            {% endfor %}
                        </select>
                        <input type="number" class="form-control mb-2" name="channel_id" placeholder="Channel ID" required>
                        <textarea class="form-control mb-2" name="message" rows="2" required></textarea>
                        <button type="submit" class="btn btn-dark btn-sm w-100">å‘é€</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('testBtn').addEventListener('click', async () => {
        const span = document.getElementById('testResult');
        span.innerText = "æµ‹è¯•ä¸­...";
        try {
            const req = await fetch('/test_api', {method: 'POST'});
            const data = await req.json();
            span.innerText = data.response;
        } catch (e) { span.innerText = "Error: " + e; }
    });
</script>
</body>
</html>